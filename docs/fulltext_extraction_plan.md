# レポート本文取得 実装計画

## 目的
- 既存のタイトル別レポート一覧（CSV/JSON）から個別レポート本文を自動取得する。
- HTMLビューア／PDFレポート双方に対応し、テキスト化した結果を構造化データとして保存する。
- 取得結果は日付・カテゴリごとに再利用できるよう `reports/<date>/fulltext/` 以下へ出力する。

## スコープ
- 対象レポート: `reports/<date>/` に出力済みのカテゴリ別CSV（為替モーニングコメント、欧州市場コメント、米国市場コメント、マクロ・スナップショット）と `overseas_reports.json`。
- 出力形式: JSON（本文全文）および必要に応じてプレーンテキスト。CSVには概要のみを追記。
- セッション: 既存 `storage_state.json` を利用し、Playwright Chromium コンテキストでアクセス。

## 制約 / 留意事項
- レポート本文は社内機密扱いの可能性があるため、保存先やアクセス権に注意する。
- PDFテキスト抽出には追加依存（例: `pdf-parse`）が必要。Node.jsで完結させる。
- 大量アクセスを避けるため、レート制限（例: 1リクエスト毎に 2 秒ウェイト）を設ける。
- 取得失敗時はログとリトライリストを必ず残す。

## 実装タスク
1. **基盤整備**
   - Playwright再利用ヘルパーを作成（ブラウザ生成、ページ生成、待機ユーティリティ）。
   - CSV/JSON読み込みユーティリティ（URL重複排除、カテゴリ情報保持）。
2. **本文取得モジュール**
   - HTMLレポート抽出: 主要セレクタの調査（実レポート数件で `document.querySelector`）、本文テキスト取得関数を実装。
   - PDFレポート抽出: `pdf-parse` 導入、ダウンロード→テキスト化→一時ファイル削除のフローを実装。
   - URL種別判定ロジック（Content-Type または URLパターン検出）。
3. **取得パイプライン**
   - 1カテゴリ（CSV）を処理するCLIコマンドを作成（例 `node scripts/fetchFulltext.js --date 2025-10-04 --category 為替モーニングコメント`）。
   - カテゴリ一覧を一括処理するラッパー（全キーワード分）を実装。
   - 進捗ログ（取得成功/失敗件数、所要時間）を出力。
4. **出力整形**
   - `reports/<date>/fulltext/<category>.json` 形式で本文を保存。
   - `overseas_reports.csv` に本文冒頭200字と本文ファイルパスを追記（別CSVまたは列追加）。
   - 失敗URLは `reports/<date>/fulltext/failed.csv` に書き出す。
5. **テスト/検証**
   - サンプルURL数件でHTML/PDF双方の本文取得が動作するか確認。
   - 実環境（2025-10-04）でカテゴリ別に実行し、期待する件数が出力されることを検証。
   - 失敗ケースに対してリトライ（最大2回）またはスキップ処理が働くことを確認。

## 実行手順（想定）
1. `npm install pdf-parse` など必要ライブラリ追加。
2. `node scripts/fetchFulltext.js --date 2025-10-04 --category 為替モーニングコメント` など個別実行。
3. すべてのカテゴリが成功したら `node scripts/fetchFulltext.js --date 2025-10-04 --all` で一括取得。
4. 出力フォルダで JSON/CSV を確認し、問題なければGoogle ドライブ等へ共有。

## リスクと対策
- **ページ構造変更**: セレクタが変わった場合の検出のため、本文抽出は複数候補セレクタを順に試す実装にする。
- **PDFテキストの品質**: 必要に応じて後処理で改行整理。品質が低い場合はOCRツール導入を検討。
- **セッション切れ**: エラー時にストレージステートを再作成するオプションを CLI に用意。
- **処理時間**: 1件ごとにウェイトを挟む／並列数を絞るほか、進捗ログで遅延原因を把握。

## 次のステップ
1. 主要レポートのDOM構造・PDFリンク形式をサンプル抽出してセレクタ/判定方法を確定。
2. fetchFulltextモジュールを実装し、最小限のHTMLレポートで動作確認。
3. PDF対応・エラーハンドリングを追加。
4. 全カテゴリに対して実行し、成果物をレビュー。
